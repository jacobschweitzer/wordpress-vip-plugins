!function(e){e(function(){function i(){var i={priceInput:e("#lp_js_postPriceInput"),priceTypeInput:e("#lp_js_postPriceTypeInput"),revenueModel:e("#lp_js_postPriceRevenueModel"),categoryInput:e("#lp_js_postDefaultCategoryInput"),priceSection:e("#lp_js_priceType"),pricingTypeButtonGroup:e("#lp_js_priceTypeButtonGroup"),pricingTypeButtons:e(".lp_js_priceTypeButton"),individualPriceButton:e("#lp_js_useIndividualPrice").parent(),categoryPriceSelector:"#lp_js_useCategoryDefaultPrice",categoryPriceButton:e("#lp_js_useCategoryDefaultPrice").parent(),globalPriceButton:e("#lp_js_useGlobalDefaultPrice").parent(),postEditTypeZero:e("#lp_postEditTypeZero"),priceEditSection:e("#lp_js_priceEditSection"),details:e("#lp_js_priceTypeDetails"),detailsSections:e(".lp_js_priceTypeDetailsSection"),individualPriceDetails:e("#lp_js_priceTypeDetailsIndividualPrice"),categoryPriceDetails:e("#lp_js_priceTypeDetailsCategoryDefaultPrice"),categoriesList:e(".lp_js_priceTypeDetailsCategoryDefaultPriceList"),categories:e(".lp_js_priceTypeDetailsCategoryDefaultPriceItem"),dynamicPricingToggle:e("#lp_js_toggleDynamicPricing"),dynamicPricingContainer:"#lp_js_dynamicPricingWidgetContainer",dynamicPricingResetDate:e("#lp_js_resetDynamicPricingStartDate"),expanded:"lp_is-expanded",selected:"lp_is-selected",disabled:"lp_is-disabled",dynamicPricingApplied:"lp_is-withDynamicPricing",selectedCategory:"lp_is-selectedCategory",payPerUse:"ppu",singleSale:"sis"},t=[],a=function(){i.pricingTypeButtons.mousedown(function(){l(this)}).click(function(e){e.preventDefault()}),e("#post").submit(function(){f()}),r(),i.priceInput.keyup(b(function(){n(e(this).val())},800)),e("input:radio",i.revenueModel).change(function(){c(i.priceInput.val())}),i.dynamicPricingToggle.mousedown(function(){g()}).click(function(e){e.preventDefault()}),i.dynamicPricingResetDate.mousedown(function(){y(lpVars.postId)}).click(function(e){e.preventDefault()}),e(".categorychecklist input:checkbox").on("change",function(){d()}),i.categoryPriceDetails.on("mousedown","a",function(){u(this)}).on("click","a",function(e){e.preventDefault()}),i.globalPriceButton.on("click","a",function(e){e.preventDefault(),i.globalPriceButton.hasClass("lp_is-disabled")||"0"===lpVars.postPriceBehaviour&&(i.priceEditSection.hide(),i.postEditTypeZero.show())}),i.individualPriceButton.on("click","a",function(e){e.preventDefault(),i.individualPriceButton.hasClass("lp_is-disabled")||(i.priceEditSection.show(),"0"===lpVars.postPriceBehaviour&&i.postEditTypeZero.hide())}),e(i.categoryPriceSelector).on("click",function(t){t.preventDefault(),e(i.categoryPriceSelector).parent().hasClass("lp_is-disabled")||i.priceEditSection.show()})},r=function(){var e,i,a;lpVars.is_block_editor&&(e=wp.data.select("core/edit-post"),i=wp.data.select("core/editor"),a=i.getPostEdits().categories,wp.data.subscribe(function(){e.isSavingMetaBoxes()&&(window.tinyMCE&&window.tinyMCE.triggerSave(),f()),a!==i.getPostEdits().categories&&(t=i.getPostEdits().categories,d(),a=t)}))},l=function(t){var a,r,l=e(t),o=l.parent("li"),d=l.attr("id");if(!o.hasClass(i.disabled)&&!o.hasClass(i.selected)){if(e("."+i.selected,i.pricingTypeButtonGroup).removeClass(i.selected),o.addClass(i.selected),i.priceSection.removeClass(i.expanded),i.detailsSections.velocity("slideUp",{duration:250}),"lp_js_useIndividualPrice"===d)i.priceEditSection.show(),"0"===lpVars.postPriceBehaviour&&i.postEditTypeZero.hide(),i.priceSection.addClass(i.expanded),i.dynamicPricingToggle.velocity("fadeIn",{duration:250,display:"block"}),i.priceTypeInput.val("individual price"),c(i.priceInput.val()),i.dynamicPricingToggle.text()===lpVars.i18nRemoveDynamicPricing&&(P(),i.individualPriceDetails.velocity("slideDown",{duration:250}));else if("lp_js_useCategoryDefaultPrice"===d){p();var u=e(".lp_is-selectedCategory a",i.categoriesList);a=u.attr("data-price"),r=u.attr("data-revenue-model"),n(a),s(r,!0),i.priceSection.addClass(i.expanded),i.categoryPriceDetails.velocity("slideDown",{duration:250}),i.categories.velocity("slideDown",{duration:250}),i.dynamicPricingToggle.velocity("fadeOut",{duration:250}),i.priceTypeInput.val("category default price")}else"lp_js_useGlobalDefaultPrice"===d&&("0"===lpVars.postPriceBehaviour&&(i.priceEditSection.hide(),i.postEditTypeZero.show()),a=l.attr("data-price"),r=l.attr("data-revenue-model"),n(a),s(r,!0),i.dynamicPricingToggle.velocity("fadeOut",{duration:250}),i.priceTypeInput.val("global default price"));"lp_js_useIndividualPrice"!==d||i.dynamicPricingToggle.hasClass(i.dynamicPricingApplied)?(i.dynamicPricingToggle.hasClass(i.dynamicPricingApplied)&&m(),i.priceInput.attr("disabled","disabled")):(i.priceInput.removeAttr("disabled"),setTimeout(function(){i.priceInput.focus()},50))}},n=function(e){var t=c(e);i.priceInput.val(t)},s=function(t,a){e("label",i.revenueModel).removeClass(i.selected),a&&e("input:radio[name=post_revenue_model]",i.revenueModel).parent("label").addClass(i.disabled),e("input:radio[value="+t+"]",i.revenueModel).prop("checked","checked").parent("label").removeClass(i.disabled).addClass(i.selected)},c=function(e){return e=e.toString().replace(/[^0-9\,\.]/g,""),e="string"==typeof e&&e.indexOf(",")>-1?parseFloat(e.replace(",",".")).toFixed(2):parseFloat(e).toFixed(2),isNaN(e)&&(e=0),e=Math.abs(e),e>lpVars.limits.sis_max?e=lpVars.limits.sis_max:e>0&&e<lpVars.limits.ppu_min&&(e=lpVars.limits.ppu_min),o(e),e=e.toFixed(2),lpVars.locale.indexOf("de_DE")!==-1&&(e=e.replace(".",",")),e},o=function(t){var a=e("input:radio:checked",i.revenueModel).val(),r=e("input:radio[value="+i.payPerUse+"]",i.revenueModel),l=e("input:radio[value="+i.singleSale+"]",i.revenueModel);0===t||t>=lpVars.limits.ppu_min&&t<=lpVars.limits.ppu_max?r.parent("label").removeClass(i.disabled):r.parent("label").addClass(i.disabled),t>=lpVars.limits.sis_min_limit?l.parent("label").removeClass(i.disabled):l.parent("label").addClass(i.disabled),t>lpVars.limits.ppu_max&&a===i.payPerUse?l.prop("checked",!0):t<lpVars.limits.sis_min_limit&&a===i.singleSale&&r.prop("checked",!0),e("label",i.revenueModel).removeClass(i.selected),e("input:radio:checked",i.revenueModel).parent("label").addClass(i.selected)},p=function(){var t=i.categoryInput.val(),a=i.categories.first();if(!i.categories.length)return void i.categoryInput.val("");if("undefined"!=typeof t&&e("[data-category="+t+"]",i.categories.parent()).length?e("[data-category="+t+"]",i.categories.parent()).addClass(i.selectedCategory):(a.addClass(i.selectedCategory),i.categoryInput.val(a.data("category"))),i.categoryPriceButton.hasClass(i.selected)){var r=e(".lp_is-selectedCategory a",i.categoriesList),l=r.attr("data-price"),c=r.attr("data-revenue-model");n(l),s(c,!0)}},d=function(){var a,r,c=e("#categorychecklist :checkbox:checked"),o=c.length,p=[];if(!lpVars.is_block_editor)for(t=[],a=0;a<o;a++)r=parseInt(c.eq(a).val(),10),t.push(r);e.post(lpVars.ajaxUrl,{action:"laterpay_get_category_prices",form:"laterpay_get_category_prices",category_ids:t},function(t){t.success&&t.prices&&(t.prices.forEach(function(i){var t=parseFloat(i.category_price).toFixed(2)+" "+lpVars.currency,a=e("<li/>",{"data-category":i.category_id,calss:"lp_price-type-categorized__item"}).append(e("<a/>",{href:"#","data-price":i.category_price,"data-revenue-model":i.revenue_model}).append(e("<span/>").text(t)).append(i.category_name));p.push(a)}),i.categoriesList.empty().append(p),t.prices.length?(i.categoryPriceButton.removeClass(i.disabled).removeClass(i.selected).removeClass("lp_tooltip"),i.categories=e("#lp_js_priceTypeDetailsCategoryDefaultPrice li"),l(i.categoryPriceSelector),i.globalPriceButton.addClass(i.disabled).addClass("lp_tooltip").attr("data-tooltip",lpVars.i18nGlobalDisabled)):(i.categoryPriceButton.addClass(i.disabled).addClass("lp_tooltip").attr("data-tooltip",lpVars.i18nCategoryPriceSelect),t.no_category_price_set===!0&&i.categoryPriceButton.attr("data-tooltip",lpVars.i18nCategoryPriceNotSetup),i.globalPriceButton.removeClass(i.disabled).removeClass("lp_tooltip"),i.detailsSections.velocity("fadeOut",{duration:250}),i.categoryPriceButton.hasClass(i.selected)&&(e("."+i.selected,i.pricingTypeButtonGroup).removeClass(i.selected),i.priceSection.removeClass(i.expanded),i.globalPriceButton.hasClass(i.disabled)?(i.individualPriceButton.addClass(i.selected),i.priceTypeInput.val("individual price"),i.dynamicPricingToggle.velocity("fadeIn",{duration:250,display:"block"}),i.priceInput.removeAttr("disabled"),n(0),s(i.payPerUse,!1)):(i.globalPriceButton.addClass(i.selected),i.priceTypeInput.val("global default price"),n(lpVars.globalDefaultPrice),s(e("a",i.globalPriceButton).attr("data-revenue-model"),!0)))))},"json")},u=function(t){var a=e(t),r=a.parent(),l=r.attr("data-category"),c=a.attr("data-price"),o=a.attr("data-revenue-model");i.categories.removeClass(i.selectedCategory),r.addClass(i.selectedCategory),i.categoryInput.val(l),n(c),s(o,!0)},g=function(){i.dynamicPricingToggle.hasClass(i.dynamicPricingApplied)?(m(),i.revenueModel.velocity("fadeIn",{duration:250,display:"inline-block"})):_()},y=function(i){e.post(lpVars.ajaxUrl,{action:"laterpay_reset_post_publication_date",post_id:i},function(e){e.success?window.location.reload():e.message&&alert(e.message)},"json")},_=function(){P(),i.dynamicPricingToggle.addClass(i.dynamicPricingApplied),i.priceInput.attr("disabled","disabled"),i.individualPriceDetails.velocity("slideDown",{duration:250}),i.priceTypeInput.val("individual price, dynamic"),i.dynamicPricingToggle.text(lpVars.i18nRemoveDynamicPricing).attr("data-icon","e")},m=function(){v(),i.dynamicPricingToggle.removeClass(i.dynamicPricingApplied),i.individualPriceDetails.velocity("slideUp",{duration:250,complete:function(){e(i.dynamicPricingContainer).empty()}}),i.dynamicPricingResetDate.velocity("fadeOut",{duration:250}),i.dynamicPricingToggle.text(lpVars.i18nAddDynamicPricing).attr("data-icon","c"),"individual price, dynamic"===i.priceTypeInput.val()&&(i.priceTypeInput.val("individual price"),i.priceInput.removeAttr("disabled"))},v=function(){e.post(lpVars.ajaxUrl,{action:"laterpay_remove_post_dynamic_pricing",post_id:lpVars.postId},function(e){e.message&&alert(e.message)},"json")},P=function(){e.post(lpVars.ajaxUrl,{action:"laterpay_get_dynamic_pricing_data",post_id:lpVars.postId,post_price:i.priceInput.val()},function(e){if(e){var t=new DynamicPricingWidget(i.dynamicPricingContainer),a=e.values[0].y,r=e.values[3].y,l=0,n=5;window.dynamicPricingWidget=t,i.priceInput.attr("disabled","disabled"),a>lpVars.limits.ppu_max||r>lpVars.limits.ppu_max?(n=lpVars.limits.sis_max,l=lpVars.limits.sis_only_limit):a>=lpVars.limits.sis_min||r>=lpVars.limits.sis_min?(n=lpVars.limits.ppu_max,l=lpVars.limits.sis_min):(n=lpVars.limits.ppu_only_limit,l=lpVars.limits.ppu_min),e.price.pubDays>0&&e.price.pubDays<=30&&t.set_today(e.price.pubDays,e.price.todayPrice),4===e.values.length?t.set_data(e.values).setPrice(l,n,lpVars.globalDefaultPrice).plot():t.set_data(e.values).setPrice(l,n,lpVars.globalDefaultPrice).interpolate("step-before").plot()}},"json")},f=function(){var t=jQuery("#lp_js_priceTypeButtonGroup li.lp_is-selected").text().trim(),a=100*c(i.priceInput.val()),r="Pricing for Post",l="LP WP Post",n=lpVars.gaData.sandbox_merchant_id+" | "+lpVars.postId+" | ",s=[];if(lpVars.is_block_editor){var o=e("div.editor-post-taxonomies__hierarchical-terms-list :checkbox:checked");e.each(o,function(i){s.push(e(o[i]).next("label").text().trim())})}else{var p=e("#categorychecklist :checkbox:checked");e.each(p,function(i){s.push(e("#"+p[i].id).parent().text().trim())})}if(lpGlobal.sendLPGAEvent("Post Published",l,n+s.join(",")),!i.dynamicPricingToggle.hasClass(i.dynamicPricingApplied))return void lpGlobal.sendLPGAEvent(r,l,n+t,a);var d=window.dynamicPricingWidget.get_data();return 4===window.dynamicPricingWidget.get_data().length?(e("input[name=start_price]").val(d[0].y),e("input[name=end_price]").val(d[3].y),e("input[name=change_start_price_after_days]").val(d[1].x),e("input[name=transitional_period_end_after_days]").val(d[2].x),e("input[name=reach_end_price_after_days]").val(d[3].x),lpGlobal.sendLPGAEvent(r,l,n+t,Math.round(100*d[3].y)),lpGlobal.sendLPGAEvent(r,l,n+"Dynamic Price",Math.round(100*d[0].y))):3===window.dynamicPricingWidget.get_data().length&&(e("input[name=start_price]").val(d[0].y),e("input[name=end_price]").val(d[2].y),e("input[name=change_start_price_after_days]").val(d[1].x),e("input[name=transitional_period_end_after_days]").val(0),e("input[name=reach_end_price_after_days]").val(d[2].x)),!0},b=function(e,i){var t;return function(){var a=this,r=arguments;clearTimeout(t),t=setTimeout(function(){e.apply(a,r)},i)}},h=function(){a(),i.dynamicPricingToggle.hasClass(i.dynamicPricingApplied)&&P()};h()}i()})}(jQuery);